name: GDF-Agent Auto Tagging

on:
  push:
    branches:
      - Dev
      - QA
      - Prod

jobs:
  Release-Agent:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}

    env:
      PROJECT_ID: ${{ vars.PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      DATASTORE_ID: ${{ vars.DATASTORE_ID }}
      ENVIRONMENT: ${{ github.ref_name }}

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Configure Git
      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # 3ï¸âƒ£ Update Webhook URLs (only if folder exists)
      - name: Update Webhook URLs
        run: |
          echo "ğŸ” Checking for 'webhooks' folder..."
          if [ ! -d "webhooks" ]; then
            echo "âš ï¸ No 'webhooks' folder found â€” skipping webhook updates."
            exit 0
          fi

          echo "ğŸ” Updating webhook URLs for environment: ${ENVIRONMENT}..."
          any_missing=false

          for file in webhooks/*.json; do
            [ -f "$file" ] || continue
            filename=$(basename "$file" .json)
            function_name=$(echo "$filename" | tr '[:upper:]' '[:lower:]')
            webhook_url="https://${REGION}-${PROJECT_ID}.cloudfunctions.net/${function_name}"

            if [ -z "$PROJECT_ID" ]; then
              echo "âŒ Missing PROJECT_ID environment variable!"
              any_missing=true
            else
              echo "âœ… Updating $filename with URL â†’ $webhook_url"
              jq --arg url "$webhook_url" '.genericWebService.uri = $url' "$file" > tmp.json && mv tmp.json "$file"
            fi
          done

          if [ "$any_missing" = true ]; then
            echo "ğŸš« Missing required environment variables. Exiting."
            exit 1
          fi

      # 4ï¸âƒ£ Update Tool DataStore Config (repo-level check)
      - name: Update Tool DataStore Config
        run: |
          echo "ğŸ§© Checking for 'tools' folder..."
          if [ ! -d "tools" ]; then
            echo "âš ï¸ No 'tools' folder found â€” skipping DataStore updates."
            exit 0
          fi

          TOOL_FILES=$(find "tools" -type f -path "tools/R4B-DS*/" -name "*.json" 2>/dev/null || true)
          if [ -z "$TOOL_FILES" ]; then
            echo "â„¹ï¸ No 'R4B-DS' JSON files found â€” skipping DataStore updates."
            exit 0
          fi

          echo "ğŸ§© Updating DataStore references inside R4B-DS folders..."
          for file in $TOOL_FILES; do
            echo "ğŸ”§ Processing: $file"
            jq --arg pid "$PROJECT_ID" --arg dsid "$DATASTORE_ID" \
              '.dataStoreSpec.dataStoreConnections[0].dataStore =
               "projects/\($pid)/locations/us/collections/default_collection/dataStores/\($dsid)"' \
              "$file" > tmp.json && mv tmp.json "$file"
            echo "âœ… Updated dataStore â†’ $DATASTORE_ID"
          done

      # 5ï¸âƒ£ Commit and push updates
      - name: Commit and Push Updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Committing webhook and datastore updates for ${ENVIRONMENT}..."
          git fetch origin ${ENVIRONMENT} --tags
          git checkout ${ENVIRONMENT}

          # Add only if files exist
          [ -d "webhooks" ] && git add webhooks/*.json || echo "ğŸŸ¡ No webhooks folder to commit"
          [ -d "tools" ] && git add tools/R4B-DS*/. -f 2>/dev/null || echo "ğŸŸ¡ No tools folder to commit"

          git diff --cached --quiet && echo "ğŸŸ¢ No changes detected. Skipping commit." && exit 0

          git commit -m "Updated webhooks & datastore config for ${ENVIRONMENT} (${PROJECT_ID})"
          git push origin ${ENVIRONMENT}
          echo "âœ… Updates pushed successfully."

      # 6ï¸âƒ£ Determine tag prefix
      - name: Set Tag Prefix
        id: prefix
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          if [ "$BRANCH_NAME" == "Dev" ]; then
            echo "prefix=GDF-Dev" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "QA" ]; then
            echo "prefix=GDF-QA" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "Prod" ]; then
            echo "prefix=GDF-Prod" >> $GITHUB_OUTPUT
          else
            echo "Unknown branch, skipping tag"
            exit 1
          fi

      # 7ï¸âƒ£ Generate next tag version
      - name: Generate Next Tag
        id: version
        run: |
          PREFIX=${{ steps.prefix.outputs.prefix }}
          LAST_TAG=$(git tag --list "${PREFIX}-v*" | sort -V | tail -n 1)
          echo "Last Tag: $LAST_TAG"
          if [ -z "$LAST_TAG" ]; then
            NEXT_VERSION="${PREFIX}-v1"
          else
            VERSION_NUM=$(echo $LAST_TAG | grep -oE '[0-9]+$')
            NEXT_VERSION="${PREFIX}-v$((VERSION_NUM + 1))"
          fi
          echo "Next Version: $NEXT_VERSION"
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      # 8ï¸âƒ£ Create and push version tag
      - name: Create and Push Tag
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}
          echo "ğŸ· Tag pushed: ${{ steps.version.outputs.version }}"
