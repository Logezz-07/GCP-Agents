name: Restore Dialogflow CX Agent

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to restore"
        required: true
        default: "Dev"
        type: choice
        options:
          - Dev
          - QA
          - Prod
      git_tag:
        description: "Tag to checkout"
        required: true

jobs:
  build-and-restore:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      PROJECT_ID: ${{ vars.PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      AGENT_ID: ${{ vars.AGENT_ID }}

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_tag }}

      # 2Ô∏è‚É£ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3Ô∏è‚É£ Install cxcli
      - name: Install cxcli
        run: |
          echo "‚¨áÔ∏è Installing cxcli..."
          curl -L -o cxcli.tar.gz https://github.com/xavidop/dialogflow-cx-cli/releases/download/v1.239.0/cxcli_Linux_x86_64.tar.gz
          tar -xzf cxcli.tar.gz
          sudo mv cxcli /usr/local/bin/
          cxcli version

      # 4Ô∏è‚É£ Build agent zip (excluding workflows)
      - name: Build agent zip
        run: |
          echo "üì¶ Building agent.zip (excluding .github/workflows)..."
          zip -r agent.zip . -x ".github/workflows/*"
          echo "‚úÖ agent.zip created successfully:"
          ls -lh agent.zip

      # 5Ô∏è‚É£ Restore Dialogflow CX Agent
      - name: Restore Dialogflow CX Agent
        run: |
          echo "üöÄ Restoring agent to ${{ github.event.inputs.environment }} environment"
          echo "üìç PROJECT_ID=${PROJECT_ID}, REGION=${REGION}, AGENT_ID=${AGENT_ID}"

          cxcli agent restore "$AGENT_ID" \
            --project-id "$PROJECT_ID" \
            --location-id "$REGION" \
            --input agent.zip \
            --output-format json \
            --verbose
